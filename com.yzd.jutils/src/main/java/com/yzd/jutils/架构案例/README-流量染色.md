## 流量染色
- [网易轻舟微服务9月重大更新：流量染色与gRPC服务托管](https://sq.163yun.com/blog/article/331977098249682944)
- [降低测试成本，屏蔽gRPC复杂性，轻舟新增流量染色和gRPC托管服务](http://www.pcpop.com/article/6065633.shtml)
```
特性简介
根据流量协议设置对应的流量染色规则，对指定的流量进行染色标记，并在整个调用链中携带该标记，以便于对染色流量进行跟踪和路由。
典型使用场景
3.全链路灰度发布
新版本在正式发布前，可以使用流量染色控制先进行小规模验证，通过收集使用体验的数据，对应用新版本的功能、性能、稳定性等指标进行评判，然后再全量升级。即使某个新版本出现问题，也只会影响已染色流量，不会蔓延至整个系统，从而保证业务的正常运行。
2.多测试环境管理
当用户需要在一个测试环境中管理多个测试分支时，可以通过流量染色标记不同的测试分支流量，将该流量路由至测试版本，从而提供整体测试环境的复用性的同时，避免了不同测试分支的互相干扰。

流量染色的三种妙用

流量染色是指根据流量协议设置对应的流量染色规则，对指定的流量进行染色标记，并在整个调用链中携带该标记。通过染色流量可以对特定的流量进行跟踪和路由，所以流量染色功能常被用于灰度发布的场景。在业务系统迭代过程中会不断有新版本发布，在正式发布前，可以使用流量染色控制先进行小规模验证，通过收集使用体验的数据，对应用新版本的功能、性能、稳定性等指标进行评判，然后再全量升级。即使某个新版本出现问题，也只会影响已染色流量，不会将问题蔓延至整个系统，保证整个系统的正常运行。

同理，流量染色功能还可以用于大促前的性能压测。在线上压测的场景中，为了让压测数据和正式的线上数据实现隔离，常用的方法是对于消息队列，缓存，数据库使用影子的方式。这就需要流量染色的技术，带一个tag进去，说明这个请求是测试数据，还是真实数据。

此外，流量染色功能还可以用于多测试环境的治理。在大规模微服务场景下，不可能每个部门部署一套完整的环境，因为耗费的资源量实在是太大了。这时候就需要合理规划测试环境，可以建立一个基准测试环境，对应Master分支，里面部署全量的应用。每一个分支对应有更新的模块，比如说你修改了五个工程，测试的时候，不需要部署全量的应用，只需要把这五个工程去创建一个Delta测试环境就可以了。

当客户端进行测试的时候，通过流量染色标记不同的测试分支流量，将该流量路由至测试版本。当这五个服务之内相互调用的时候，微服务框架就会选择这五个服务的实例进行调用，如果需要调用五个服务之外的其他服务的时候，微服务框架会到Master环境里面，选择服务实例进行调用。有了流量染色的环境治理机制，测试环境数量会大大减少。
```